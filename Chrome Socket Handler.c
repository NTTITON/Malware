#include <windows.h>
#include "Chrome Socket Handler.h"

PCHROMESOCKET InitialSocket = 0;
PCHROMESOCKET CurrentSocket = 0;
PCHROMESOCKET LastSocket = 0;

INT TotalSockets = 0;

PCHROMESOCKET AllocateStructure()
{
	HANDLE hHeap = GetProcessHeap();
	PCHROMESOCKET NewStructure = (PCHROMESOCKET)HeapAlloc(hHeap,0,sizeof(CHROMESOCKET));
	if (NewStructure)
		RtlSecureZeroMemory(NewStructure, sizeof(CHROMESOCKET));
	return NewStructure;
}

BOOL DeleteStructure(PCHROMESOCKET Structure)
{
	HANDLE hHeap = GetProcessHeap();
	return HeapFree(hHeap,0,Structure);
}

PCHROMESOCKET InitializeSocketList(SOCKET s, LPCRITICAL_SECTION lpSection)
{

	EnterCriticalSection(lpSection);
	if (!LastSocket)
	{
		LastSocket = AllocateStructure();
	}


	if (InitialSocket == 0)
	{

		InitialSocket = AllocateStructure();
		if (InitialSocket)
		{
			InitialSocket->Next = LastSocket;
			InitialSocket->Prev = LastSocket;
			InitialSocket->Socket = s;

			CurrentSocket = InitialSocket;
			TotalSockets++;
		}
	}
	LeaveCriticalSection(lpSection);

	return InitialSocket;
}

PCHROMESOCKET FindSocket(SOCKET s, LPCRITICAL_SECTION lpSection)
{
	PCHROMESOCKET pCurrent = (PCHROMESOCKET)InitialSocket;

	EnterCriticalSection(lpSection);
	if (InitialSocket)
	{
		do
		{
			if (pCurrent->Socket == s)
				return pCurrent;

			if (pCurrent->Next == 0)
				break;

			pCurrent = pCurrent->Next;
		}while(1);
	}
	LeaveCriticalSection(lpSection);

	return 0;
}

PCHROMESOCKET InsertSocket(SOCKET s, LPCRITICAL_SECTION lpSection)
{

	PCHROMESOCKET NewSocket = 0;

	
	if (InitialSocket == 0)
	{
		return InitializeSocketList(s, lpSection);
	}

	EnterCriticalSection(lpSection);
	NewSocket = AllocateStructure();
	if (NewSocket)
	{
		NewSocket->Next = LastSocket;
		NewSocket->Prev = CurrentSocket;
		NewSocket->Socket = s;
		CurrentSocket->Next = NewSocket;
		CurrentSocket = NewSocket;
		TotalSockets++;
	}
	LeaveCriticalSection(lpSection);

	return NewSocket;

}

INT RemoveSocket(SOCKET s, LPCRITICAL_SECTION lpSection)
{
	PCHROMESOCKET pCurrent = (PCHROMESOCKET)InitialSocket;
	PCHROMESOCKET Temp = 0;
	INT TotalSocketsRemoved = 0;

	EnterCriticalSection(lpSection);
	if (pCurrent)
	{
		do
		{
			Temp = pCurrent->Next;
			if(pCurrent->Socket == s)
			{

				if (pCurrent == InitialSocket)
				{

					if (pCurrent->Next != LastSocket)
					{

						InitialSocket = pCurrent->Next;
						pCurrent->Next->Prev = LastSocket;

					}
					else
					{
						InitialSocket = 0;
					}
				}
				else if (pCurrent->Next == LastSocket)
				{
					pCurrent->Prev->Next = LastSocket;
					CurrentSocket = pCurrent->Prev;

				}
				else
				{

					pCurrent->Next->Prev = pCurrent->Prev;
					pCurrent->Prev->Next = pCurrent->Next;
				}


				DeleteStructure(pCurrent);
				TotalSocketsRemoved++;

			}

			if (pCurrent->Next == 0)
				break;

			pCurrent = Temp;
		}while(1);
	}

	TotalSockets-=TotalSocketsRemoved;
	LeaveCriticalSection(lpSection);

	return TotalSocketsRemoved;
}