
#include <Windows.h>

#define SIZE 256

void rc4_crypt(unsigned char *s, size_t datalen, unsigned char *d, size_t keylen)
{
	unsigned char S[SIZE];
	unsigned char *data = s;
	unsigned char *key = d;
	int i,j,k,tmp;

	for(i = 0; i < SIZE;i++)
		S[i] = i;

	for(j = i = 0; i < SIZE;i++) {
		j = (j + S[i] + key[i%keylen]) % SIZE;
		tmp = S[i];
		S[i] = S[j];
		S[j] = tmp;   
	}

	for(i = j = k = 0; (unsigned long)k < datalen;k++) {
		i = (i + 1) % SIZE;
		j = (j + S[i]) % SIZE;
		tmp = S[i];
		S[i] = S[j];
		S[j] = tmp;
		tmp = S[(S[i] + S[j]) % SIZE];
		data[k] ^= tmp;
	}
}
